# Ръководство за филтриране на часове и управление на работно време

Това ръководство обяснява как да използвате новите функции за филтриране на свободни часове и управление на работното време на календари без пряк достъп до Acuity Scheduling интерфейса.

## 1. Филтриране на свободни часове (45-минутни интервали)

### Какво прави?

Acuity API връща свободни часове на всеки 15 минути (например: 08:00, 08:15, 08:30, 08:45, 09:00...). Новата функция позволява да филтрирате тези часове, за да показвате само тези на :00 и :45 минути.

### Как работи?

**На ниво API:**
- Заявката към `/acuity/availability/times` връща всички налични часове от Acuity (обикновено на всеки 15 мин)
- Клиентският код филтрира резултатите преди да ги покаже

**Примерна логика:**

```javascript
const slots = await getSlotsFromAcuityAPI(); // слотове през 15 мин
const filtered = slots.filter(slot => {
  const minutes = new Date(slot.time).getMinutes();
  return minutes === 0 || minutes === 45; // позволяваме само 45-мин стъпка
});
```

### Как да използвате в Acuity Manager?

1. **Отворете Acuity Manager** (`acuity-manager.html`)
2. **Отидете в таб "Нова резервация"**
3. **Намерете секцията** "Свободни часове с филтриране (45-мин. интервали)"
4. **Изберете:**
   - Тип услуга (задължително)
   - Календар (опционално)
   - Дата (задължително)
5. **Поставете отметка** на "Филтрирай само :00 и :45 минути"
6. **Натиснете** "Виж свободни часове"

### Резултат

Вместо да виждате:
```
08:00  08:15  08:30  08:45  09:00  09:15  09:30  09:45  10:00
```

Ще виждате само:
```
08:00  08:45  09:00  09:45  10:00
```

### Предимства

- ✅ **Не променя календара в Acuity** - промените са само визуални
- ✅ **Не изисква API права за редакция** - работи само с четене
- ✅ **Лесно да се включи/изключи** - чрез checkbox
- ✅ **Работи с всички планове на Acuity** - не изисква upgrade

### Ограничения

- ⚠️ Филтрирането е само на ниво клиент - ако клиентът използва директно Acuity, ще види всички часове
- ⚠️ За истинско ограничаване на интервалите трябва да промените `schedulingIncrement` в Acuity

## 2. Управление на работно време чрез API

### Какво прави?

Позволява ви да обновите работното време (availability time ranges) на календара директно чрез API, без да влизате в Acuity интерфейса.

### Как работи?

Изпраща `PATCH` заявка към `/acuity/calendars/{calendarId}` с нови времеви диапазони.

**API заявка:**

```bash
PATCH /acuity/calendars/{calendarId}
Authorization: Bearer {API_KEY}
Content-Type: application/json

{
  "timeRanges": [
    { "start": "08:00", "end": "12:00" },
    { "start": "13:00", "end": "17:00" }
  ]
}
```

### Как да използвате в Acuity Manager?

1. **Отворете Acuity Manager** (`acuity-manager.html`)
2. **Отидете в таб "Календари"**
3. **Намерете секцията** "Обновяване на работно време (чрез API)"
4. **Изберете календар** от падащото меню
5. **Натиснете** "Зареди текущо работно време" за да видите текущите настройки
6. **Добавете времеви диапазони:**
   - Натиснете "Добави времеви диапазон" за всеки период
   - Въведете начален час (напр. 08:00)
   - Въведете краен час (напр. 12:00)
   - Повторете за допълнителни периоди (напр. 13:00 - 17:00)
7. **Натиснете** "Запази работно време"

### Примерни сценарии

**Сценарий 1: Стандартен работен ден с обедна почивка**
```
Време 1: 08:00 - 12:00
Време 2: 13:00 - 17:00
```

**Сценарий 2: Разделен график**
```
Време 1: 06:00 - 10:00 (сутрешна смяна)
Време 2: 14:00 - 18:00 (следобедна смяна)
```

**Сценарий 3: Кратък работен ден**
```
Време 1: 10:00 - 14:00
```

### Предимства

- ✅ **Не изисква достъп до Acuity интерфейс**
- ✅ **Може да се автоматизира**
- ✅ **Бързо и лесно променяне на работното време**
- ✅ **Визуализация на текущите настройки**

### Ограничения

- ⚠️ Изисква API права за редакция на календари (не всички Acuity планове ги поддържат)
- ⚠️ Променя реалните настройки в Acuity (не е само визуално)
- ⚠️ Задава работно време за целия календар, не по дни от седмицата

### Алтернативи при липса на API права

Ако вашият Acuity план не поддържа API редакция на календари:

1. **Използвайте блокове** (availability blocks):
   - Отидете в секция "Блокиране на часове"
   - Създайте блокове за нежеланите периоди
   - Примери:
     - Блокирайте 00:00-08:00 за да затворите сутрините
     - Блокирайте 18:00-23:59 за да затворите вечерите
     - Блокирайте цели дни за почивни дни

2. **Използвайте бързия помощник** за график:
   - Автоматизира създаването на блокове
   - Позволява повтарящи се блокове
   - Подходящ за дългосрочни промени

## 3. Комбинирано използване

Можете да комбинирате двете функции за максимален контрол:

### Стъпка 1: Задайте работно време
```
08:00 - 17:00 (чрез API или блокове)
```

### Стъпка 2: Филтрирайте слотовете
```
Показвайте само :00 и :45 минути
```

### Резултат
Клиентите ще виждат:
```
08:00, 08:45, 09:00, 09:45, 10:00, 10:45, 11:00, 11:45, 12:00, 12:45, 13:00, 13:45, 14:00, 14:45, 15:00, 15:45, 16:00
```

Вместо всички часове на всеки 15 минути.

## 4. Технически детайли

### API Endpoints

**Проверка на свободни дати:**
```
GET /acuity/availability?appointmentTypeID={id}&month={YYYY-MM}&calendarID={id}
```

**Проверка на свободни часове:**
```
GET /acuity/availability/times?appointmentTypeID={id}&date={YYYY-MM-DD}&calendarID={id}
```

**Обновяване на календар:**
```
PATCH /acuity/calendars/{id}
Body: { "timeRanges": [...] }
```

### JavaScript функции

**Филтриране на часове:**
```javascript
function filterSlotsTo45MinIntervals(slots) {
    return slots.filter(slot => {
        const timeStr = typeof slot === 'object' ? slot.time : slot;
        const date = new Date(timeStr);
        const minutes = date.getMinutes();
        return minutes === 0 || minutes === 45;
    });
}
```

**Зареждане на свободни часове:**
```javascript
async function checkAvailableTimes() {
    const appointmentTypeID = '...';
    const date = '2024-01-15';
    const calendarID = '...';
    
    const response = await fetch(
        `${WORKER_URL}/acuity/availability/times?appointmentTypeID=${appointmentTypeID}&date=${date}&calendarID=${calendarID}`
    );
    
    let slots = await response.json();
    
    if (filter45min) {
        slots = filterSlotsTo45MinIntervals(slots);
    }
    
    displayAvailableTimes(slots);
}
```

## 5. Често задавани въпроси

**Q: Може ли да филтрирам часовете по различен начин (напр. само пълни часове)?**

A: Да, променете функцията `filterSlotsTo45MinIntervals()`:

```javascript
// Само пълни часове (:00)
return minutes === 0;

// Само :00 и :30
return minutes === 0 || minutes === 30;

// Само четни часове
const hours = date.getHours();
return minutes === 0 && hours % 2 === 0;
```

**Q: Може ли да задам различно работно време за различни дни от седмицата?**

A: Acuity API не поддържа различни времеви диапазони по дни директно чрез `timeRanges`. Вместо това използвайте блокове за конкретни дни.

**Q: Какво се случва ако клиентът използва директно Acuity вместо моя филтриран интерфейс?**

A: Филтрирането на часове работи само в интерфейса на Acuity Manager. Ако клиентите резервират директно през Acuity, ще видят всички налични часове. За истинско ограничаване променете `schedulingIncrement` в настройките на услугата.

**Q: Може ли да автоматизирам промяната на работното време?**

A: Да, можете да използвате API-то директно или да автоматизирате чрез скриптове. Примерен cURL:

```bash
curl -X PATCH "https://workerai.radilov-k.workers.dev/acuity/calendars/12342518" \
  -H "Content-Type: application/json" \
  -d '{"timeRanges": [{"start": "08:00", "end": "17:00"}]}'
```

## 6. Troubleshooting

**Проблем: Не виждам новите секции в интерфейса**

Решение:
- Презаредете страницата с Ctrl+F5
- Уверете се, че сте на последната версия на файловете

**Проблем: Филтрирането не работи**

Решение:
- Проверете дали отметката "Филтрирай..." е поставена
- Отворете browser console за грешки
- Уверете се, че има налични часове за избраната дата

**Проблем: Не мога да запазя работно време**

Решение:
- Уверете се, че вашият Acuity план поддържа API редакция
- Проверете дали Worker има правилни ACUITY_USER и ACUITY_KEY
- Проверете дали времевите диапазони са валидни (начало < край)

**Проблем: Получавам грешка "Current plan does not have access to this api"**

Решение:
- Вашият Acuity план не поддържа API редакция на календари
- Използвайте блокове вместо това
- Или надградете вашия Acuity план

## 7. Заключение

Новите функции за филтриране на часове и управление на работно време предоставят гъвкавост при управлението на Acuity Scheduling без нужда от директен достъп до интерфейса. 

- Използвайте **филтрирането на часове** за бързи визуални промени
- Използвайте **управлението на работно време** за постоянни промени в календара
- Комбинирайте двете за максимален контрол

За допълнителни въпроси или проблеми, моля отворете issue в GitHub repository.
